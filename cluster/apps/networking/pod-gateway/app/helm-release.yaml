---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: angelnu
spec:
  interval: 15m
  url: https://angelnu.github.io/helm-charts
  timeout: 3m
---
# yaml-language-server: $schema=https://kubernetes-schemas.dmfrey.com/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: pod-gateway

spec:
  interval: 1h
  chart:
    spec:
      chart: pod-gateway
      version: 7.1.1
      sourceRef:
        kind: HelmRepository
        name: angelnu
  values:
    # Pasted from:
    # https://github.com/angelnu/helm-charts/blob/bceb8cc91d54895f1a4975c79ec520e88fbafe4b/charts/apps/pod-gateway/values.yaml

    #
    # IMPORTANT NOTE
    #
    # This chart inherits from our common library chart. You can check the default values/options here:
    # https://github.com/k8s-at-home/library-charts/tree/main/charts/stable/common/values.yaml
    #

    controllers:
      main:
        # Configure the main controller - this runs the VPN server
        containers:
          gluetun:
            enabled: true
            dependsOn: main
            image:
              # -- image repository
              repository: ghcr.io/qdm12/gluetun
              # -- image tag
              tag: v3.41.1@sha256:1a5bf4b4820a879cdf8d93d7ef0d2d963af56670c9ebff8981860b6804ebc8ab
            env:
              - name: VPN_SERVICE_PROVIDER
                value: "private internet access"
              - name: VPN_INTERFACE
                value: tun0
              - name: OPENVPN_ENDPOINT_PORT
                value: 1197
              - name: OPENVPN_PROTOCOL
                value: udp
                # Make sure firewall is off, otherwise child pods cannot reach gateway pod.
              - name: FIREWALL_ENABLED_DISABLING_IT_SHOOTS_YOU_IN_YOUR_FOOT
                value: "off"
              - name: DOT
                value: "off"
              - name: SERVER_REGIONS
                value: "CA Montreal"
              - name: LOG_LEVEL
                value: debug
              - name: LOG_CONFS
                value: "true"

            envFrom:
              - secretRef:
                  name: pod-gateway-secret

            securityContext:
              privileged: true
              # capabilities:
              #   add:
              #     - NET_ADMIN

            resources:
              requests:
                cpu: 5m
                memory: 64M
                my.home/tun: 1
              limits:
                my.home/tun: 1
                memory: 128M

            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - if [ $(wget -q -O- https://ipinfo.io/city) == 'MontrÃ©al' ]; then exit 0; else exit $?; fi
                  initialDelaySeconds: 30
                  periodSeconds: 60
                  failureThreshold: 3

    # -- IP address of the DNS server within the vxlan tunnel.
    # All mutated PODs will get this as their DNS server.
    # It must match VXLAN_GATEWAY_IP in settings.sh
    DNS: 172.16.1.1

    # -- The DNSPolicy to apply to the POD. Only when set to "None" will the
    # DNS value above apply. To avoid altering POD DNS (i.e., to allow
    # initContainers to use DNS before the the VXLAN is up), set to "ClusterFirst"
    DNSPolicy: None

    # -- cluster name used to derive the gateway full name
    clusterName: "cluster.local"

    # -- Namespaces that might contain routed PODs and therefore
    # require a copy of the gneerated settings configmap.
    routed_namespaces:
      - vpn

    settings:
      # -- IPs not sent to the POD gateway but to the default K8S.
      # Multiple CIDRs can be specified using blanks as separator.
      # Example for Calico: ""172.22.0.0/16 172.24.0.0/16"
      #
      # This is needed, for example, in case your CNI does
      # not add a non-default rule for the K8S addresses (Flannel does).
      # NOT_ROUTED_TO_GATEWAY_CIDRS: ""
      NOT_ROUTED_TO_GATEWAY_CIDRS: "10.0.0.0/8"

      # -- Vxlan ID to use
      VXLAN_ID: 43
      # -- VXLAN needs an /24 IP range not conflicting with K8S and local IP ranges
      VXLAN_IP_NETWORK: 172.16.1
      # -- Keep a range of IPs for static assignment in nat.conf
      # VXLAN_GATEWAY_FIRST_DYNAMIC_IP: 20

      # -- If using a VPN, interface name created by it
      VPN_INTERFACE: tun0
      # -- Prevent non VPN traffic to leave the gateway
      VPN_BLOCK_OTHER_TRAFFIC: true # maybe should be false # Need liveness probe to go through
      # -- If VPN_BLOCK_OTHER_TRAFFIC is true, allow VPN traffic over this port
      VPN_TRAFFIC_PORT: 1197
      # -- Traffic to these IPs will be send through the K8S gateway
      VPN_LOCAL_CIDRS: "10.0.0.0/8"

      # VPN Port Forwarding:
      VPN_PORT_FORWARDING: "on"
      VPN_PORT_FORWARDING_UP_COMMAND: /bin/sh -c '/usr/bin/wget -O- --retry-connrefused --post-data "json={\"listen_port\":{{PORTS}}}" http://qbittorrent.vpn.svc.cluster.local/api/v2/app/setPreferences 2>&1'

      # -- DNS queries to these domains will be resolved by K8S DNS instead of
      # the default (typcally the VPN client changes it)
      # DNS_LOCAL_CIDRS: "local"

    # -- settings to expose ports, usually through a VPN provider.
    # NOTE: if you change it you will need to manually restart the gateway POD
    publicPorts:
      - hostname: qbittorrent
        IP: 10
      # ports:
      # - type: udp
      #   port: "${BITTORRENT_PORT}"
      # - type: tcp
      #   port: "${BITTORRENT_PORT}"

    # -- The webhook is used to mutate the PODs matching the given
    # namespace labels. It inserts an init and sidecard helper containers
    # that connect to the gateway pod created by this chart.
    # @default -- See below
    webhook:
      namespaceSelector:
        type: label
        label: "routed-gateway"
        custom: {}
        #   matchExpressions:
        #     - key: notTouch
        #       operator: NotIn
        #       values: ["1"]

      # -- default behviour for new PODs in the evaluated namespace
      gatewayDefault: false

      # -- label name to check when evaluating POD. If true the POD
      # will get the gateway. If not set setGatewayDefault will apply.
      gatewayLabel: setGateway

      # -- label value to check when evaluating POD. If set, the POD
      # with the gatewayLabel's value that matches, will get the
      # gateway. If not set gatewayLabel boolean value will apply.
      gatewayLabelValue:

      # -- annotation name to check when evaluating POD. If true the POD
      # will get the gateway. If not set setGatewayDefault will apply.
      gatewayAnnotation: setGateway

      # -- annotation value to check when evaluating POD. If set, the POD
      # with gatewayAnnotation'value that matches, will get the gateway.
      # If not set gatewayAnnotation boolean value will apply.
      gatewayAnnotationValue:

      # -- determines how sidecar container is created
      # sidecarAsInit: false
